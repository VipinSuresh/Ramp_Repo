WITH transactions_by_day AS (
    SELECT
        CAST(transaction_time AS DATE) AS date,
        SUM(transaction_amount) AS total_transaction_amount
    FROM transactions
    GROUP BY CAST(transaction_time AS DATE)
    ORDER BY CAST(transaction_time AS DATE)
),
rolling_average AS (
    SELECT
        date,
        total_transaction_amount,
        AVG(total_transaction_amount) OVER (
            ORDER BY date
            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
        ) AS rolling_3_day_avg
    FROM transactions_by_day
)
SELECT
    date,
    total_transaction_amount AS total_amount,
    rolling_3_day_avg
FROM rolling_average
WHERE date = '2021-01-31';
